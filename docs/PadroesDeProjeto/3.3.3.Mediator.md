# 3.3.3. Mediator

## Vis√£o Geral

## Princ√≠pios e Vantagens
A ado√ß√£o do padr√£o Mediator traz diversos benef√≠cios alinhados aos princ√≠pios de bom design de software:
- **Desacoplamento:** Os componentes n√£o se comunicam diretamente entre si, toda a comunica√ß√£o passa pelo mediator, reduzindo depend√™ncias r√≠gidas.
- **Centraliza√ß√£o da comunica√ß√£o:** O mediator atua como √∫nico ponto de controle para intera√ß√µes complexas entre objetos.
- **Responsabilidade √∫nica:** Cada objeto mant√©m suas pr√≥prias responsabilidades, enquanto o mediator gerencia a l√≥gica de coordena√ß√£o.
- **Flexibilidade e extensibilidade:** Novos componentes podem ser adicionados sem modificar os objetos existentes, apenas integrando-os ao mediator.


## Casos de Uso

##### ‚úÖ Quando usar Mediator?
O padr√£o Mediator √© indicado quando:  
- H√° muitos objetos interdependentes, com comunica√ß√£o complexa.  
- Queremos reduzir acoplamento direto entre os componentes.  
- Desejamos centralizar regras de neg√≥cio que envolvem m√∫ltiplos objetos.

##### üö´ Quando N√ÉO usar?
Evite o padr√£o Mediator quando:
- A comunica√ß√£o entre objetos √© simples e direta; adicionar um mediator apenas adicionaria complexidade desnecess√°ria.
- Os objetos podem se comunicar de forma natural sem gerar acoplamento excessivo.
- N√£o h√° necessidade de centralizar regras de neg√≥cio; cada objeto pode gerenciar suas pr√≥prias responsabilidades de forma clara.

## Estrutura do Mediator

A estrutura do Mediator envolve:

1. **Mediator (interface):** define os m√©todos que o mediador deve implementar.  
2. **Concrete Mediator (concreto):** implementa a l√≥gica de coordena√ß√£o entre os colegas.  
3. **Colleague (colegas/servi√ßos):** componentes que interagem entre si atrav√©s do mediator (PostService, ScoreService, NotificationService, RankingService).  

## Modelagem no Projeto (Diagrama UML)

O diagrama abaixo ilustra a estrutura do padr√£o em nosso projeto, cobrindo a **Mediator Interface** ```(IMediator)```, o **Concrete Mediator** ```(CompetitionMediator)```, os **Colleagues** ```PostService```, ```RankingService```,```NotificationService```,```ScoreService```, um **servi√ßo desacoplado do Mediator** ```FeedService``` e um modelo de dados provis√≥rio ```CompetitionPostData```.

![Mediator](../assets/Mediator.svg)
<center>
<p style="text-align: center"><b>Figura 1:</b> Diagrama UML Mediator</p>

<b>Autor(es):</b>  <a href="https://github.com/JoaoPedro2206" target="_blank">Jo√£o Pedro Ferreira Moraes</a>, <a href="https://github.com/JoseViniciusQueiroz" target="_blank">Jos√© Vinicius Alvares Soares de Queiroz</a>, <a href="https://github.com/leohssjr" target="_blank">Leonardo Henrique Sobral Sauma Junior</a>. 2025
<br>Link Artefato: <a href="https://drive.google.com/file/d/1kqnaC-gqSgNk1bYo2YVXbS5GnjkHgHXt/view?usp=sharing" target="_blank">Draw.io</a>
</p>
</font> 
</center>

## Implementa√ß√£o Mediator (C√≥digo)
### Colleagues
#### FeedService.ts
```2025.2-T01-G6-QueroBemEstar_Entrega_03/mediator/src/components/FeedService.ts
import { RecipeData } from "../models/types";

export class FeedService {
  private recipes: RecipeData[] = [];

  addRecipe(recipe: RecipeData) {
    this.recipes.push(recipe);
    console.log(`[FeedService] Receita adicionada: ${recipe.recipeId}`);
  }

  getRecipes() {
    return this.recipes;
  }
}
```

#### NotificationService.ts
```2025.2-T01-G6-QueroBemEstar_Entrega_03/mediator/src/components/NotificationService.ts
interface NotificationItem {
  id: number;
  message: string;
}

export class NotificationService {
  private notifications: { [userId: string]: NotificationItem[] } = {};
  private nextId = 1;

  notify(userId: string, message: string) {
    if (!this.notifications[userId]) this.notifications[userId] = [];
    this.notifications[userId].push({ id: this.nextId++, message });
    console.log(`[NotificationService] Notifica√ß√£o para ${userId}: ${message}`);
  }

  // Retorna todas as notifica√ß√µes, sem limpar
  getNotificationsForUser(userId: string) {
    return this.notifications[userId] || [];
  }
}
```

#### PostService.ts
```2025.2-T01-G6-QueroBemEstar_Entrega_03/mediator/src/components/PostService.ts
import { CompetitionPostData } from "../models/types";

export class PostService {
  private posts: CompetitionPostData[] = [];
  private likes: { [postId: string]: string[] } = {}; 

  createPost(post: CompetitionPostData) {
    this.posts.push(post);
    this.likes[post.postId] = [];
    console.log(`[PostService] Post competi√ß√£o criado: ${post.postId}`);
  }

  likePost(postId: string, likedBy: string) {
    if (!this.likes[postId]) this.likes[postId] = [];
    if (!this.likes[postId].includes(likedBy)) {
      this.likes[postId].push(likedBy);
    }
    console.log(`[PostService] Post ${postId} curtido por ${likedBy}`);
  }

  getLikes(postId: string) {
    return this.likes[postId] || [];
  }

  getPosts() {
    return this.posts;
  }
}
```

#### RankingService.ts
```2025.2-T01-G6-QueroBemEstar_Entrega_03/mediator/src/components/RankingService.ts
export class RankingService {
  updateRanking(scores: { [userId: string]: number }) {
    const ranking = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .map(([userId, score], index) => ({ position: index + 1, userId, score }));
    console.log("[RankingService] Ranking atualizado:", ranking);
  }
}
```

#### ScoreService.ts
```2025.2-T01-G6-QueroBemEstar_Entrega_03/mediator/src/components/ScoreService.ts
export class RankingService {
  updateRanking(scores: { [userId: string]: number }) {
    const ranking = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .map(([userId, score], index) => ({ position: index + 1, userId, score }));
    console.log("[RankingService] Ranking atualizado:", ranking);
  }
}
```

### Mediator

#### Interface Mediator: IMediator.ts
```mediator/src/mediator/IMediator.ts
import { CompetitionPostData } from "../models/types";

export interface IMediator {
  registerCompetition(competitionId: string, participants: string[]): void;
  postLiked(postId: string, likedBy: string, postOwnerId?: string): void;
  postCreated(postId: string, userId: string, competitionId: string): void;
}

export type { CompetitionPostData };
```
#### Concrete Mediator: CompetitionMediator.ts
```mediator/src/mediator/CompetitionMediator.ts
import { PostService } from "../components/PostService";
import { ScoreService } from "../components/ScoreService";
import { NotificationService } from "../components/NotificationService";
import { RankingService } from "../components/RankingService";
import { IMediator } from "./IMediator";

export class CompetitionMediator implements IMediator {
  private competitionParticipants: { [competitionId: string]: string[] } = {};
  private onNotify?: (message: string) => void;
  private awardedPosts: Set<string> = new Set();

  constructor(
    private postService: PostService,
    private scoreService: ScoreService,
    private notificationService: NotificationService,
    private rankingService: RankingService,
    onNotify?: (message: string) => void
  ) {
    this.onNotify = onNotify;
  }

  registerCompetition(competitionId: string, participants: string[]) {
    this.competitionParticipants[competitionId] = participants;
  }

  postLiked(postId: string, likedBy: string, postOwnerId: string) {
    const post = this.postService.getPosts().find(p => p.postId === postId);
    const ownerId = postOwnerId || post?.userId;
    const competitionId = post?.competitionId;
    if (!ownerId) return;

    const message = `${likedBy} curtiu seu post ${postId}`;
    this.notificationService.notify(ownerId, message);
    if (this.onNotify) this.onNotify(message);

    this.checkAndAward(postId, ownerId, competitionId);
  }

  postCreated(postId: string, userId: string, competitionId: string) {
    const message = `Post ${postId} criado na competi√ß√£o ${competitionId}`;
    this.notificationService.notify(userId, message);
    if (this.onNotify) this.onNotify(message);
  }

  private checkAndAward(postId: string, userId: string, competitionId?: string) {
    if (this.awardedPosts.has(postId)) return;

    if (!competitionId) {
      const post = this.postService.getPosts().find(p => p.postId === postId);
      competitionId = post?.competitionId;
    }

    const likes = this.postService.getLikes(postId);
    const participants = this.competitionParticipants[competitionId || ""] || [];
    const requiredLikes = Math.ceil(participants.length / 2);

    if (likes.length >= requiredLikes) {
      // Adiciona pontos e atualiza ranking
      this.scoreService.addPoints(userId, 10);
      const msg = "Seu post foi validado e voc√™ ganhou 10 pontos!";
      this.notificationService.notify(userId, msg);
      this.rankingService.updateRanking(this.scoreService.getScores());
      this.awardedPosts.add(postId);
      if (this.onNotify) this.onNotify(msg);
    }
  }
}
```

## V√≠deo Apresenta√ß√£o
<iframe width="1425" height="570" src="https://www.youtube.com/embed/qMKVMnJvZ9E" title="Mediator" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Tabela de Participa√ß√£o
| Integrante | Contribui√ß√µes Principais |
|-------------|------------------------------------------------------------------------------------------|
| [Leonardo Sauma](https://github.com/leohssjr) | Respons√°vel principal pelo desenvolvimento do padr√£o **Mediator**, incluindo a implementa√ß√£o, explica√ß√£o te√≥rica e cria√ß√£o do diagrama UML. |
| [Jo√£o Pedro Moraes](https://github.com/JoaoPedro2206) | Contribuiu com revis√£o do conte√∫do e feedback na estrutura do c√≥digo. |
| [Jos√© Vinicius](https://github.com/JoseViniciusQueiroz) | Contribuiu na elabora√ß√£o do diagrama UML e na  formata√ß√£o final do texto sobre o padr√£o Mediator. |

## Refer√™ncias Bibliograficas
> REFACTORING GURU. Design Patterns. Dispon√≠vel em: <https://refactoring.guru/design-patterns>. Acesso em: 23 out. 2025.

> GLEEK. Class Diagram Arrows Explained. Dispon√≠vel em: <https://www.gleek.io/blog/class-diagram-arrows#google_vignette>. Acesso em: 23 out. 2025.

> SERRANO, Milene. AULA - GOFs Comportamentais. [Apresenta√ß√£o de slides utilizada na disciplina de Arquitetura e Desenho de Software] ‚Äì [Universidade de Basilia], 2025.

## Hist√≥rico de Vers√£o

| Vers√£o | Data | Altera√ß√£o | Respons√°vel | Revisor | Data de revis√£o |
| ------ | ---- | --------- | ----------- | ------- | --------------- |
| 1.0    | 23/10/2025 | Cria√ß√£o do documento e conte√∫do sobre o Mediator. | [Leonardo Sauma](https://github.com/leohssjr) | | |